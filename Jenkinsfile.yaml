pipeline:
  agent: any

  options:
    - "ansiColor('xterm')"

  stages:
    - stage: "🏗️ Prepare environment"
      steps:
        - sh "python3 -m virtualenv venv"

    - stage: "Install dependencies"
      steps:
        script:
          - withPythonEnv: "'venv/'"
            script:
              - sh "python3 -m pip install --upgrade pip"
              - sh "make install-test"

    - stage: "✅ Run tests"
      steps:
        script:
          - withPythonEnv: "'venv/'"
            script:
              - sh "make test"

    - stage: "🕵️ Collect test reports"
      steps:
        - "junit(testResults: 'output/tests/tests.xml')"
        - "cobertura(coberturaReportFile: 'output/coverage/coverage.xml')"

  post:
    failure:
      - "slackSend(color: 'danger', channel: '#continious-integration', tokenCredentialId: 'slack-token', message: '🔥 Failed build (ml_pipeline)')"
    always:
      - "cleanWs()"
